!function(P){var C=0;P.fn.uploadify=function(e){var i={fileTypeExts:"",uploader:"",auto:!1,method:"post",multi:!1,formData:{},fileObjName:"filedata",fileSizeLimit:2048,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"",removeTimeout:1e3,itemTemplate:'        <div id="${fileID}" class="uploadify-queue-item">            <div class="uploadify-progress">                <div class="uploadify-progress-bar"></div>            </div>            <span class="up_filename">${fileName}</span>            <span class="uploadbtn">上传</span>            <span class="delfilebtn">删除</span>        </div>        ',breakPoints:!1,isBurst:!0,fileSplitSize:1048576,isResizeImg:!0,isConcurrent:!1,isSvgJudge:!1,isSvgToPng:!1,getFileSizeUrl:"",getUploadSizeParam:null,fileSizeLimitTips:"单个文件大小不能超过",getUploadedSize:function l(e){var i={fileMd5:e.md5,fileSplitSize:m.fileSplitSize,fileName:e.name,totalSize:e.size},t=P.extend(i,m.getUploadSizeParam),n=0;return P.ajax({url:m.getFileSizeUrl,async:!1,type:"post",dataType:"json",data:t,success:function a(e){e.success?n=e.size:(n=-1,m.msgInfo("error",e.msg))}}),n},msgInfo:function t(e,i){Fai.ing(i)},saveUploadedSize:null,saveInfoLocal:!1,onUploadStart:null,onUploadProgress:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSvgSelect:null,onSelect:null},m=P.extend(i,e),v={mimetypeMap:{zip:["application/x-zip-compressed"],jpg:["image/jpg"],svg:["image/svg+xml"],jpeg:["image/jpeg"],png:["image/png"],gif:["image/gif"],bmp:["image/bmp"],doc:["application/msword"],xls:["application/vnd.ms-excel"],docx:["application/vnd.openxmlformats-officedocument.wordprocessingml.document"],xlsx:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],ppt:["application/vnd.ms-powerpoint "],pptx:["application/vnd.openxmlformats-officedocument.presentationml.presentation"],mp3:["audio/mp3"],mp4:["video/mp4"],pdf:["application/pdf"],exe:["application/x-msdownload"],html:["text/html"],ico:["image/x-icon"],txt:["text/plain"],flv:[".flv"],swf:["application/x-shockwave-flash"],psd:[".psd"],ai:[".ai"]},setUploader:function n(e){m.uploader=e},formatFileSize:function a(e,i){return e=1048576<e&&!i?(Math.round(100*e/1048576)/100).toString()+"MB":(Math.round(100*e/1024)/100).toString()+"KB"},getFile:function s(e,i){for(var t=0;t<i.length;t++)if(i[t].index==e)return i[t];return!1},getMimetype:function o(e){return this.mimetypeMap[e]},getFileTypes:function r(e){for(var i=[],t=e.split(";"),n=0,a=t.length;n<a;n++)i.push(t[n].split(".").pop());return i},getAcceptString:function p(e){for(var i=this,t=this.getFileTypes(e),n=[],a=0,l=t.length;a<l;a++){var s=i.getMimetype(t[a]);s&&n.push(s)}return n.join(",")},statble:90,uploadProgress:function d(e){if("start"==e.status){var i='                    <div id="progressPanel'+e.id+'" class="mission">                        <div id="progress'+e.id+'" class="progress" style="width:1%;"></div>                        <div class="progressTextPanel">                            <div class="progressText">'+e.title+'</div>                            <div class="progressPercent">0%</div>                        </div>                    </div>                    ';P("#progressPanel"+e.id).length<1&&P("#img_"+e.id).append(i),this.statble=90}else if("ing"==e.status){var t=e.percent;P("#progressPanel"+e.id+" .progressText").text(e.title);var n=h.fileFilter[0].name,a=v.getFileTypes(n)[0].toLowerCase(),l=null==v.getMimetype(a)?"":v.getMimetype(a)[0];if(e.percent>this.statble&&100!=e.percent){var s=Math.random()/5;this.statble+=parseFloat(s.toFixed(0)),this.statble=parseFloat(this.statble.toFixed(0)),t=this.statble}0<=l.indexOf("image")?(P("#progress"+e.id).css("width",t+"%"),P("#progressPanel"+e.id+" .progressPercent").html(t+"%")):(P("#progress"+e.id).css("width",e.percent+"%"),P("#progressPanel"+e.id+" .progressPercent").html(e.percent+"%")),P("#progress"+e.id).attr("width",e.percent),0<=l.indexOf("image")&&99<e.percent&&this.dynamicProgress(e.id)}else"end"==e.status?(P("#progressPanel"+e.id+" .progressText").text(e.title),P("#progressBody_"+e.id).remove(),P("#progressWrap_"+e.id).remove()):"error"==e.status&&P("#progress"+e.id).addClass("progressError")},dynamicProgress:function f(e){90!=this.statble&&(this.statble+=.5,100<this.statble||(this.statble=parseFloat(this.statble.toFixed(2)),P("#progress"+e).css("width",this.statble+"%"),P("#progressNum"+e).html(this.statble+"%"),setTimeout(function(){this.dynamicProgress(e)},1e3).bind(this)))},isResizeImg:function u(e){return!!(""!=e.type&&~"image/jpeg,image/jpg,image/png".indexOf(e.type)&&4194304<e.size)},isNoResizeImg:function c(e){return!!(~"image/jpeg,image/jpg,image/png".indexOf(e.type)&&e.size<=4194304)},isImg:function g(e){return!(!~"image/jpeg,image/jpg,image/png,image/svg+xml".indexOf(e.type)||e.type==undefined||""==e.type)},resizeImg:function S(s,o,e,r,p){var d=this,f={compress:function c(e,i,t){var n=document.createElement("canvas");n.width=e.naturalWidth,n.height=e.naturalHeight;var a=n.width/n.height;n.width=o,n.height=o/a;n.getContext("2d").drawImage(e,0,0,e.naturalWidth,e.naturalHeight,0,0,o,o/a);var l=n.toDataURL(t,i/100),s=new Image;return s.src=l,s}},i=new FileReader;function u(e){for(var i=e.split(","),t=i[0].match(/:(.*?);/)[1],n=atob(i[1]),a=n.length,l=new Uint8Array(a);a--;)l[a]=n.charCodeAt(a);return new Blob([l],{type:t})}i.readAsDataURL(r),i.onload=function(e){var a=document.getElementById("imgCut"),l=document.createElement("img");l.id="imgCut_"+r.index,l.src=event.target.result,a.appendChild(l),l.onload=function(e){var i=90,t=u(f.compress(l,i,r.type).src);if(t.size<r.size?(r.source=t,s.totalSize=t.size):s.totalSize=r.size,s.totalSize>m.fileSizeLimit){var n=m.fileSizeLimit/1024/1024;d.msgInfo("warning",m.fileSizeLimitTips+n+"MB")}else s.initSize=0,s.complete=!0,h.sendBlob(h.url,p,r,s);a.removeChild(l)}}},genUploadUrl:function z(e){var i=m.uploader;for(key in e)i+="&"+key+"="+e[key];h.url=i}},h=null;return this.each(function(){var e=P(this),i='<input id="select_btn_'+ ++C+'" class="selectbtn" style="display:none;" type="file" name="fileselect[]"';i+=m.multi?" multiple":"",i+=' accept="',null==m.fileTypeExts||""==m.fileTypeExts||"*"==m.fileTypeExts?i+="*.*":i+=v.getAcceptString(m.fileTypeExts),i+='"/>',i+='<a id="file_upload_'+C+'-button" href="javascript:void(0)" class="uploadify-button">',i+=m.buttonText,i+="</a>";e.append(i),e.addClass("uploadify"),(h={uploadParam:m.post_params,uploadAllowed:!0,instanceNumber:C,fileInput:e.find(".selectbtn"),uploadFileList:P(document).find(".uploadify-queue"),url:m.uploader,fileFilter:[],maxSize:0,nowStatSize:0,uploadOver:!1,init:function t(){0<this.fileInput.length&&this.fileInput.change(function(e){h.funGetFiles(e)}),e.find(".uploadify-button").on("click",function(){e.find(".selectbtn").trigger("click")}),m.onInit&&m.onInit()},funGetFiles:function r(e){for(var i,t=this,n=e.target.files,a={showTip:!1},l=[],s=[],o=0;o<n.length;o++)i=void 0,i=n[o],/svg/.test(i.type)&&m.isSvgJudge?m.onSvgSelect&&m.onSvgSelect(s,l,i,a):s.push(i);P.when.apply(P,l).done(function(){if(a.showTip&&a.tipText&&m.msgInfo("warning",a.tipText),0<(n=s).length){for(var e=0,i=(n=t.filter(n)).length;e<i;e++)t.fileFilter.push(n[e]);if(0==t.fileFilter.length)return;return t.funDealFiles(n),t}}).fail(function(){console.log("err")})},filter:function u(e){var i=[],t=!1,n=v.getFileTypes(m.fileTypeExts);if(""!=m.fileTypeExts&&"*.*"!=m.fileTypeExts&&null!=m.fileTypeExts||(t=!0),0<n.length){for(var a=0,l=0,s=e.length;l<s;l++){var o=e[l];if(m.isResizeImg&&v.isImg(o)){if(v.isResizeImg(o)){if(o.size>m.fileSizeLimit){var r=m.fileSizeLimit/1024/1024;m.msgInfo("warning",m.fileSizeLimitTips+r+"MB"),a++;continue}}else if(!v.isNoResizeImg(o)&&2097152<o.size){m.msgInfo("warning","单个gif,bmp文件大小不能超过2MB"),a++;continue}}else if(o.size>m.fileSizeLimit){r=m.fileSizeLimit/1024/1024;m.msgInfo("warning",m.fileSizeLimitTips+r+"MB"),a++;continue}var p=o.name,d=p.indexOf("."),f="";-1!=d&&(f=p.substring(d+1)),m.siteFree&&"apk"==f?m.msgInfo("error","上传失败：您的版本目前不支持上传apk文件。"):t?i.push(o):0<=P.inArray(o.name.split(".").pop().toLowerCase(),n)?i.push(o):m.msgInfo("warning","文件"+o.name+"类型不允许！")}a===e.length&&0!=a&&(h.fileFilter=[],h.fileInput.val(""))}return i},funDealFiles:function l(e){for(var i=P(document).find(".uploadify-queue .uploadify-queue-item").length,t=0,n=e.length;t<n;t++){var a=e[t];e[t].index=++i,e[t].id="fileupload_"+C+"_"+e[t].index,e[t].md5=P.md5(e[t].name+e[t].size+e[t].type+e[t].lastModified),v.isImg(a)||!m.isBurst?m.fileSplitSize=m.fileSizeLimit/1024/1024<<10<<10:0<=e[t].size&&e[t].size<20971520?m.fileSplitSize=5242880:20971520<=e[t].size&&e[t].size<52428800?m.fileSplitSize=5242880:52428800<=e[t].size&&e[t].size<104857600?m.fileSplitSize=8388608:104857600<=e[t].size&&e[t].size<524288e3?m.fileSplitSize=10485760:m.fileSplitSize=15728640}return this.funSelect(e),this},funSelect:function p(e){if(m.onSelect&&!m.onSelect(e))return h.fileFilter=[],void h.fileInput.val("");var i=e.length,t=[],n=0;if(m.isConcurrent)if(this.maxSize=m.getMaxSize(),this.nowStatSize=m.getStatSize(),m.inBatches&&i>m.inBatches)for(var a=(t=s(m.inBatches,e))[0],l=m.batchesCount=0;l<a.length;l++)r(a[l],o);else for(l=0;l<i;l++)r(e[l]);else r(e[0]);function s(e,i){var t,n=[];for(t=0;t<i.length;)n.push(i.slice(t,t+=e));return n}function o(){m.batchesCount==m.inBatches&&setTimeout(function(){m.batchesCount=0;var e=t[++n];if(e)for(var i=0;i<e.length;i++)e[i]&&r(e[i],o)},2e3)}function r(e,i){var t=h.funGetUploadedSize(e);if(-1!=t){var n=(t/e.size*100).toFixed(0),a={status:"start",id:e.id,title:"准备上传...",percent:n,size:e.size};v.uploadProgress(a),m.breakPoints&&(a={status:"ing",id:e.id,title:"上传中...",percent:n},v.uploadProgress(a),h.funUploadFile(e,t,i))}else h.fileInput.val("")}},funUploadFile:function c(n,a,l){var s=null,o=n,r=!1;P(document).find("#fileupload_"+C+"_"+n.index);try{s=new XMLHttpRequest}catch(i){s=ActiveXobject("Msxml12.XMLHTTP")}if(m.breakPoints){var p=n.name,d=n.id,f=n.index,e=n.md5,u=n.size;u>=m.fileSplitSize?(n=o.slice(a,a+m.fileSplitSize),r=!1,h.lastSplit=!1):(r=!0,h.lastSplit=!0),n.name=p,n.id=d,n.index=f,n.md5=e}s.upload&&!1!==a&&(s.upload.addEventListener("progress",function(e){m.onUploadProgress&&m.onUploadProgress(e,n),h.onProgress(n,e.loaded,o.size)},!1),s.onreadystatechange=function(){s.newStateChange&&s.newStateChange();var e=!0;if(4==s.readyState){if(200==s.status){o.uploadOver=!0;var i=JSON.parse(s.responseText);if(i.success)m.breakPoints?(a+=m.fileSplitSize,h.funSaveUploadedSize(o,u<=a?u:a),m.isResizeImg&&v.isResizeImg(o)?h.regulateView(o,s.responseText):a<u?(e=o.uploadOver=!1,h.uploadAllowed&&(r=a+m.fileSplitSize>=u?(n=o.slice(a,u),!0):(n=o.slice(a,a+m.fileSplitSize),!1),n.name=p,n.id=d,n.index=f,n.size=u,m.formData.fileMd5=o.md5,m.formData.totalSize=o.size,m.formData.complete=r,m.formData.initSize=a,setTimeout(h.sendBlob(h.url,s,n,m.formData),2e3))):h.regulateView(o,s.responseText)):h.regulateView(o,s.responseText);else{m.msgInfo("error","文件："+n.name+"  "+i.msg);var t={status:"end",id:n.id};v.uploadProgress(t),o.uploadOver=!0,h.regulateView(o,s.responseText)}}else o.uploadOver&&(m.onUploadError&&m.onUploadError(o,s.responseText),m.msgInfo("error","服务繁忙，文件"+n.name+"上传失败，请稍候重试。"));o.uploadOver&&(m.onUploadComplete&&m.onUploadComplete(o,s.responseText),h.fileInput.val(""),v.statble=90),m.inBatches&&"batchesCount"in m&&e&&m.batchesCount++,l&&"function"==typeof l&&l()}},m.onUploadStart&&m.onUploadStart(n),m.formData.fileMd5=n.md5,m.formData.totalSize=o.size,m.formData.complete=r,m.formData.initSize=a,h.uploadAllowed=!0,v.genUploadUrl(h.uploadParam),m.isResizeImg&&v.isResizeImg(n)?v.resizeImg(m.formData,m.resizeImg.maxWidth,m.resizeImg.maxHeight,o,s):h.sendBlob(h.url,s,n,m.formData))},sendBlob:function o(e,i,t,n){if(m.isConcurrent){if(h.nowStatSize+n.totalSize>h.maxSize){var a='{"success":false,"msg":"上传资源已超过容量限制，请升级版本。"}',l={status:"end",id:t.id};return v.uploadProgress(l),t.uploadOver=!0,h.regulateView(t,a),m.onUploadComplete&&m.onUploadComplete(t,a),h.fileInput.val(""),void(v.statble=90)}h.nowStatSize+=t.size}i.open(m.method,e,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest");var s=new FormData;if(s.append(m.fileObjName,t,t.name),m.isResizeImg&&v.isResizeImg(t)&&t.source&&s.append("resizeImg",t.source,t.name),m.isSvgToPng&&s.append("pngStr",t.pngStr),n)for(key in n)s.append(key,n[key]);i.send(s)},regulateView:function n(e,i){e.uploadOver&&(m.onUploadSuccess&&m.onUploadSuccess(e,i),m.isConcurrent||(h.funDeleteFile(e.index),setTimeout(a,1500)));var a=function a(){if(0!=h.fileFilter.length){var e=h.fileFilter[0],i=h.funGetUploadedSize(e),t=i/e.size*100,n={status:"start",id:e.id,title:"准备上传...",percent:t,size:e.size};v.uploadProgress(n),n={status:"ing",id:e.id,title:"上传中...",percent:t},v.uploadProgress(n),h.funUploadFile(e,i)}}},onProgress:function d(e,i,t){var n=P("body").find("#progressWrap_"+e.id),a=i,l=n.attr("lastLoaded")||0;(i-=parseInt(l))<0&&(i=0);var s=P("#progress"+e.id),o=m.breakPoints?parseFloat(s.attr("width")):0;if(!(i<e.size)){var r=parseFloat(s.attr("old-loaded")||o/100*t)+e.size;s.attr("old-loaded",r);var p=(r/t*100).toFixed(0);p=100<=p?100:p,a<m.fileSplitSize?n.attr("lastLoaded",a):n.removeAttr("lastLoaded"),tmpoptions={status:"ing",id:e.id,title:"上传中...",percent:p},v.uploadProgress(tmpoptions)}},funGetProgressWidth:function a(e){},funGetUploadedSize:function s(e){return m.getUploadedSize?m.getUploadedSize(e):m.saveInfoLocal?parseInt(localStorage.getItem(e.name))||0:void 0},funSaveUploadedSize:function f(e,i){m.saveUploadedSize?m.saveUploadedSize(e,i):m.saveInfoLocal&&localStorage.setItem(e.name,i)},funDeleteFile:function g(e){for(var i=this.fileFilter.slice(),t=0;t<i.length;t++){var n=i[t];if(n.index==e){m.breakPoints&&(this.uploadAllowed=!1),this.fileFilter.splice(t,1),P(document).find("#fileupload_"+C+"_"+e).fadeOut(),h.fileInput.val(""),m.onCancel&&m.onCancel(n);break}}return this}}).init()}),{instanceID:h.instanceNumber,genUploadUrl:v.genUploadUrl,changeParam:function x(e){P.extend(h.uploadParam,e)},changeFormParam:function y(e){P.extend(m.formData,e)},changeInputType:function b(e,i){var t=P("#select_btn_"+e),n=v.getAcceptString(i);t.attr("accept",n)},stop:function F(){h.uploadAllowed=!1;for(var e=h.fileFilter.slice(),i=0;i<e.length;i++)e[i].uploadOver=!1,h.funDeleteFile(++i);h.fileFilter=[]},upload:function I(e){if("*"===e){var i=i=h.fileFilter.length,t=0;for(i=h.fileFilter.length;t<i;t++)h.funUploadFile(h.fileFilter[t])}else{var n=getFile(e,h.fileFilter);n&&h.funUploadFile(n)}},cancel:function w(e){if((e="*")==e)for(var i=0,t=h.fileFilter.length;i<t;i++)h.funDeleteFile(++i);else h.funDeleteFile(e)},disable:function U(e,i){e?P("#file_upload_"+e+"-button").off("click"):P(".uploadify").find(".uploadify-button").off("click")},enable:function T(e){var i="";e?i=P("#file_upload_"+e+"-button"):i=P(".uploadify").find(".uploadify-button");i.off("click").on("click",function(){P(this).prev(".selectbtn").trigger("click")})}}}}(jQuery);